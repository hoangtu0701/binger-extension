var S=Object.defineProperty;var C=Object.getOwnPropertySymbols;var D=Object.prototype.hasOwnProperty,A=Object.prototype.propertyIsEnumerable;var T=(p,i,t)=>i in p?S(p,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[i]=t,x=(p,i)=>{for(var t in i||(i={}))D.call(i,t)&&T(p,t,i[t]);if(C)for(var t of C(i))A.call(i,t)&&T(p,t,i[t]);return p};var w=(p,i,t)=>new Promise((h,f)=>{var a=r=>{try{s(t.next(r))}catch(u){f(u)}},o=r=>{try{s(t.throw(r))}catch(u){f(u)}},s=r=>r.done?h(r.value):Promise.resolve(r.value).then(a,o);s((t=t.apply(p,i)).next())});(function(){"use strict";var p=document.createElement("style");p.textContent=`body{margin-top:4.6vh;font-family:system-ui,sans-serif;background:#111;color:#fff;display:flex;flex-direction:column;align-items:center;gap:6vh}.videos{display:flex;flex-direction:row;justify-content:center;gap:2vw;width:93vw;height:73vh}video{background:#000;width:50%;height:100%;max-width:480px;aspect-ratio:16/9;object-fit:cover;border:2px solid #444;border-radius:15px}.controls{display:flex;gap:8px}.controls button{background:#222;color:#ddd;transition:background .3s;padding:8px 12px;border-radius:8px;border:none;font-size:14px;cursor:pointer}.controls button:disabled{opacity:.5;cursor:not-allowed}.controls button:hover:not(:disabled){background:#333}.spinner{display:inline-block;animation:spin 1.2s linear infinite}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}
/*$vite$:1*/`,document.head.appendChild(p),window.addEventListener("message",f=>{var u;if(((u=f.data)==null?void 0:u.type)!=="restoreCamMic")return;const{camOn:a,micOn:o}=f.data;if(!window.localStream){window.__pendingCamMicState={camOn:a,micOn:o};return}const s=window.localStream.getVideoTracks()[0],r=window.localStream.getAudioTracks()[0];typeof a=="boolean"&&s&&(s.enabled=a,document.getElementById("btnToggleCam").innerHTML=a?"📹 Cam":"🚫 Cam",document.getElementById("localVideo").style.opacity=a?"1":"0.3"),typeof o=="boolean"&&r&&(r.enabled=o,document.getElementById("btnToggleMic").innerHTML=o?"🎤 Mic":"🚫 Mic")});const i={apiKey:"AIzaSyDhppVbz4-sx1oYls62iXOPOR8Yrq-N9Qk",authDomain:"binger-video-call.firebaseapp.com",databaseURL:"https://binger-video-call-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"binger-video-call",storageBucket:"binger-video-call.firebasestorage.app",messagingSenderId:"1025922887951",appId:"1:1025922887951:web:70f733811d4ed19a8d8e7a"};firebase.initializeApp(i,"caller"),firebase.database.INTERNAL.forceWebSockets();const t=firebase.app("caller").database();function h(){return w(this,null,function*(){return new Promise(f=>{const a=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["stun:hk-turn1.xirsys.com"]},{username:"X4wXbtbVmlOqNhOpTzEyIXrHCWjAeNepUjkzMoLOnDQyPPDnZeO3HCSKDDTIW6oEAAAAAGh_w2hob2FuZ3R1Mw==",credential:"35e524c2-671d-11f0-a840-0242ac120004",urls:["turn:hk-turn1.xirsys.com:80?transport=udp","turn:hk-turn1.xirsys.com:3478?transport=udp","turn:hk-turn1.xirsys.com:80?transport=tcp","turn:hk-turn1.xirsys.com:3478?transport=tcp","turns:hk-turn1.xirsys.com:443?transport=tcp","turns:hk-turn1.xirsys.com:5349?transport=tcp"]}]});let o=!1;a.onicecandidate=s=>{if(!s.candidate){a.close(),f(!o);return}(s.candidate.candidate.includes("srflx")||s.candidate.candidate.includes("relay"))&&(o=!0)},a.createDataChannel("probe"),a.createOffer().then(s=>a.setLocalDescription(s)).catch(()=>f(!0))})})}document.addEventListener("DOMContentLoaded",()=>w(null,null,function*(){yield firebase.app("caller").auth().signInAnonymously().catch(e=>{console.error("Firebase anonymous auth failed:",e)});const o=new URLSearchParams(window.location.search).get("roomId");if(!o)return console.error("❌ roomId missing");console.log(`🚀 Joining calls/${o}`),(yield h())&&window.parent!==window&&window.parent.postMessage({type:"network-warning"},"*");const r=t.ref(`calls/${o}`),u=t.ref(`calls/${o}/users`),m=t.ref(`calls/${o}/signals`),k=u.push({joined:Date.now()}),g=k.key;console.log(`👤 User ${g} joined`),k.onDisconnect().remove(),r.onDisconnect().remove();const O=document.getElementById("localVideo"),I=document.getElementById("remoteVideo"),y=document.getElementById("btnToggleMic"),b=document.getElementById("btnToggleCam");let c=null;try{c=yield navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),window.localStream=c,window.__pendingCamMicState&&(window.postMessage(x({type:"restoreCamMic"},window.__pendingCamMicState),"*"),delete window.__pendingCamMicState),c.getTracks().forEach(e=>e.enabled=!1),O.srcObject=c,y.disabled=!1,b.disabled=!1,y.innerHTML="🚫 Mic",b.innerHTML="🚫 Cam"}catch(e){console.warn("🎥 getUserMedia failed – receive-only mode")}const n=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["stun:hk-turn1.xirsys.com"]},{username:"X4wXbtbVmlOqNhOpTzEyIXrHCWjAeNepUjkzMoLOnDQyPPDnZeO3HCSKDDTIW6oEAAAAAGh_w2hob2FuZ3R1Mw==",credential:"35e524c2-671d-11f0-a840-0242ac120004",urls:["turn:hk-turn1.xirsys.com:80?transport=udp","turn:hk-turn1.xirsys.com:3478?transport=udp","turn:hk-turn1.xirsys.com:80?transport=tcp","turn:hk-turn1.xirsys.com:3478?transport=tcp","turns:hk-turn1.xirsys.com:443?transport=tcp","turns:hk-turn1.xirsys.com:5349?transport=tcp"]}]});c?c.getTracks().forEach(e=>n.addTrack(e,c)):(n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"}));const v=new MediaStream;I.srcObject=v,n.ontrack=e=>v.addTrack(e.track),n.onicecandidate=e=>{e.candidate&&m.push({type:"candidate",from:g,payload:e.candidate.toJSON()})};const L=yield new Promise(e=>{u.once("value",d=>{const l=Object.keys(d.val()||{});l.sort(),e(l[0]===g)})});let M=!1;if(m.on("child_added",e=>w(null,null,function*(){const d=e.val();if(d.from!==g)try{switch(d.type){case"offer":if(M||n.currentRemoteDescription)return;M=!0,yield n.setRemoteDescription(d.payload);const l=yield n.createAnswer();yield n.setLocalDescription(l),m.push({type:"answer",from:g,payload:l}),console.log("📨 Answer sent");break;case"answer":n.currentRemoteDescription||(yield n.setRemoteDescription(d.payload));break;case"candidate":yield n.addIceCandidate(new RTCIceCandidate(d.payload));break}}catch(l){console.warn("⚠️ Signal handling error:",l)}})),L){const e=yield n.createOffer();yield n.setLocalDescription(e),m.push({type:"offer",from:g,payload:e}),console.log("📨 Offer sent (I’m offerer)")}else console.log("🕗 Waiting for offer… (I’m answerer)");n.oniceconnectionstatechange=()=>{n.iceConnectionState==="connected"&&m.remove().catch(()=>{})},c&&(y.onclick=()=>{var d,l;const e=c.getAudioTracks()[0];e.enabled=!e.enabled,y.innerHTML=e.enabled?"🎤 Mic":"🚫 Mic",window.parent.postMessage({type:"updateCamMic",camOn:(l=(d=c.getVideoTracks()[0])==null?void 0:d.enabled)!=null?l:!1,micOn:e.enabled},"*")},b.onclick=()=>{var d,l;const e=c.getVideoTracks()[0];e.enabled=!e.enabled,b.innerHTML=e.enabled?"📹 Cam":"🚫 Cam",O.style.opacity=e.enabled?"1":"0.3",window.parent.postMessage({type:"updateCamMic",camOn:e.enabled,micOn:(l=(d=c.getAudioTracks()[0])==null?void 0:d.enabled)!=null?l:!1},"*")}),window.addEventListener("beforeunload",()=>{n.close(),c&&c.getTracks().forEach(e=>e.stop())})}))})();
