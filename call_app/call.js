var i=(w,m,r)=>new Promise((d,l)=>{var e=s=>{try{b(r.next(s))}catch(u){l(u)}},g=s=>{try{b(r.throw(s))}catch(u){l(u)}},b=s=>s.done?d(s.value):Promise.resolve(s.value).then(e,g);b((r=r.apply(w,m)).next())});(function(){"use strict";const w='body{--call-bg: #111;--call-video-bg: #000;--call-video-border: #444;--call-btn-bg: #222;--call-btn-color: #ddd;--call-btn-hover: #333;--call-text: #fff;--call-overlay-bg: rgba(0, 0, 0, .7);--call-spinner-border: #fff;overflow:hidden;margin-top:4.6vh;font-family:system-ui,sans-serif;background:var(--call-bg);color:var(--call-text);display:flex;flex-direction:column;align-items:center;gap:6vh}body.theme-burgundy{--call-bg: rgba(15, 5, 10, .95);--call-video-bg: rgba(8, 2, 5, .9);--call-video-border: rgba(180, 80, 100, .3);--call-btn-bg: rgba(140, 40, 55, .3);--call-btn-color: #d4a574;--call-btn-hover: rgba(140, 40, 55, .5);--call-overlay-bg: rgba(15, 5, 10, .85);--call-spinner-border: #d4a574}body.theme-pink{--call-bg: rgba(35, 18, 25, .95);--call-video-bg: rgba(20, 10, 15, .9);--call-video-border: rgba(220, 140, 170, .25);--call-btn-bg: rgba(210, 110, 140, .2);--call-btn-color: #e8a0b5;--call-btn-hover: rgba(210, 110, 140, .35);--call-overlay-bg: rgba(35, 18, 25, .85);--call-spinner-border: #e8a0b5}body.theme-blackwhite{--call-bg: rgba(6, 6, 8, .95);--call-video-bg: rgba(2, 2, 3, .9);--call-video-border: rgba(255, 255, 255, .1);--call-btn-bg: rgba(255, 255, 255, .06);--call-btn-color: rgba(255, 255, 255, .7);--call-btn-hover: rgba(255, 255, 255, .12);--call-overlay-bg: rgba(6, 6, 8, .9);--call-spinner-border: rgba(255, 255, 255, .7)}body.theme-ocean{--call-bg: rgba(4, 14, 24, .95);--call-video-bg: rgba(2, 8, 16, .9);--call-video-border: rgba(0, 180, 220, .2);--call-btn-bg: rgba(0, 100, 160, .25);--call-btn-color: #b0e8f0;--call-btn-hover: rgba(0, 100, 160, .4);--call-overlay-bg: rgba(4, 14, 24, .85);--call-spinner-border: #b0e8f0}body.theme-volcano{--call-bg: rgba(12, 6, 4, .95);--call-video-bg: rgba(6, 3, 2, .9);--call-video-border: rgba(255, 100, 30, .2);--call-btn-bg: rgba(200, 60, 10, .2);--call-btn-color: #e8a060;--call-btn-hover: rgba(200, 60, 10, .35);--call-overlay-bg: rgba(12, 6, 4, .85);--call-spinner-border: #e8a060}body.theme-forest{--call-bg: rgba(6, 14, 4, .95);--call-video-bg: rgba(3, 8, 2, .9);--call-video-border: rgba(100, 200, 100, .2);--call-btn-bg: rgba(60, 120, 40, .2);--call-btn-color: #c0e8a0;--call-btn-hover: rgba(60, 120, 40, .35);--call-overlay-bg: rgba(6, 14, 4, .85);--call-spinner-border: #c0e8a0}.videos{display:flex;flex-direction:row;justify-content:center;gap:2vw;width:93vw;height:73vh}video{background:var(--call-video-bg);width:50%;height:100%;max-width:480px;aspect-ratio:16/9;object-fit:cover;border:2px solid var(--call-video-border);border-radius:15px}.controls{display:flex;gap:8px;position:relative}.controls button{background:var(--call-btn-bg);color:var(--call-btn-color);transition:background .3s;padding:8px 12px;border-radius:8px;border:none;font-size:14px;cursor:pointer;position:relative}.controls button:disabled{opacity:.5;cursor:not-allowed}.controls button:hover:not(:disabled){background:var(--call-btn-hover)}.audio-tooltip{position:absolute;bottom:calc(100% + 12px);left:50%;transform:translate(-50%);width:240px;padding:10px 12px;border-radius:10px;background:var(--call-overlay-bg);color:var(--call-btn-color);font-size:11.5px;line-height:1.5;text-align:center;pointer-events:none;opacity:0;transition:opacity .25s ease;backdrop-filter:blur(12px);border:1px solid var(--call-video-border);z-index:10000}.audio-tooltip:after{content:"";position:absolute;top:100%;left:50%;transform:translate(-50%);border:6px solid transparent;border-top-color:var(--call-overlay-bg)}.controls button#btnToggleAudio:hover:not(:disabled) .audio-tooltip{opacity:1}.audio-tooltip-title{font-weight:700;font-size:12px;margin-bottom:4px}.audio-tooltip-desc{opacity:.8;transition:opacity .3s ease}.audio-tooltip-desc.audio-tooltip-fading{opacity:0!important;transition:opacity .3s ease}.spinner{display:inline-block;animation:spin 1.2s linear infinite}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.call-spinner-circle{border:4px solid var(--call-spinner-border);border-top:4px solid transparent;border-radius:50%;width:30px;height:30px;margin:0 auto 12px}',m=document.createElement("style");m.textContent=w,document.head.appendChild(m);const r={firebase:{apiKey:"AIzaSyDhppVbz4-sx1oYls62iXOPOR8Yrq-N9Qk",authDomain:"binger-video-call.firebaseapp.com",databaseURL:"https://binger-video-call-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"binger-video-call",storageBucket:"binger-video-call.firebasestorage.app",messagingSenderId:"1025922887951",appId:"1:1025922887951:web:70f733811d4ed19a8d8e7a"},connectionTimeout:3e4,disconnectedTimeout:1e4,networkProbeTimeout:5e3,maxIceRestarts:2,iceRestartDelay:1500,iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:["stun:hk-turn1.xirsys.com"]},{urls:"turn:free.expressturn.com:3478",username:"000000002068909891",credential:"aXZXgcUQf/fSE9PUID9byOo2BME="},{username:"X4wXbtbVmlOqNhOpTzEyIXrHCWjAeNepUjkzMoLOnDQyPPDnZeO3HCSKDDTIW6oEAAAAAGh_w2hob2FuZ3R1Mw==",credential:"35e524c2-671d-11f0-a840-0242ac120004",urls:["turn:hk-turn1.xirsys.com:80?transport=udp","turn:hk-turn1.xirsys.com:3478?transport=udp","turn:hk-turn1.xirsys.com:80?transport=tcp","turn:hk-turn1.xirsys.com:3478?transport=tcp","turns:hk-turn1.xirsys.com:443?transport=tcp","turns:hk-turn1.xirsys.com:5349?transport=tcp"]}]},d={micOn:"ðŸŽ¤ Mic",micOff:"ðŸš« Mic",camOn:"ðŸ“¹ Cam",camOff:"ðŸš« Cam",audioSpeaker:"ðŸ”Š Speaker",audioHeadphones:"ðŸŽ§ Headphones"},l={RESTORE_CAM_MIC:"restoreCamMic",UPDATE_CAM_MIC:"updateCamMic",RESTORE_AUDIO_MODE:"restoreAudioMode",UPDATE_AUDIO_MODE:"updateAudioMode",NETWORK_WARNING:"network-warning",CLEANUP_CALL:"cleanupCall",CLEANUP_DONE:"cleanupDone"},e={peerConnection:null,localStream:null,remoteStream:null,userId:null,roomId:null,isOfferer:!1,gotOffer:!1,connectionEstablished:!1,isReconnecting:!1,iceRestartCount:0,triedRelayOnly:!1,connectionTimer:null,disconnectedTimer:null,audioMode:"speaker",roomRef:null,usersRef:null,signalsRef:null,userRef:null,elements:{localVideo:null,remoteVideo:null,btnMic:null,btnCam:null,btnAudio:null,loadingOverlay:null},resizeListener:null,signalListener:null};window.localStream=null,firebase.initializeApp(r.firebase,"caller"),firebase.database.INTERNAL.forceWebSockets();const g=firebase.app("caller").database(),b=["theme-burgundy","theme-pink","theme-blackwhite","theme-ocean","theme-volcano","theme-forest"];function s(n){b.forEach(t=>document.body.classList.remove(t)),n&&n!=="default"&&document.body.classList.add(`theme-${n}`)}window.addEventListener("message",n=>{const{type:t}=n.data||{};if(t==="setTheme"){s(n.data.theme);return}if(t===l.RESTORE_CAM_MIC){const{camOn:o,micOn:a}=n.data;if(!window.localStream){window.__pendingCamMicState={camOn:o,micOn:a};return}u(o,a);return}if(t===l.RESTORE_AUDIO_MODE){const{audioMode:o}=n.data;if(o==="speaker"||o==="headphones"){if(e.audioMode=o,!window.localStream){window.__pendingAudioMode=o;return}v(o)}return}if(t===l.CLEANUP_CALL){P(),window.parent!==window&&window.parent.postMessage({type:l.CLEANUP_DONE},"*");return}});function u(n,t){const o=window.localStream;if(!o)return;const a=o.getVideoTracks()[0],c=o.getAudioTracks()[0];typeof n=="boolean"&&a&&(a.enabled=n,R(n),D(n)),typeof t=="boolean"&&c&&(c.enabled=t,C(t))}function O(){var t,o,a,c;if(window.parent===window)return;const n=window.localStream;n&&window.parent.postMessage({type:l.UPDATE_CAM_MIC,camOn:(o=(t=n.getVideoTracks()[0])==null?void 0:t.enabled)!=null?o:!1,micOn:(c=(a=n.getAudioTracks()[0])==null?void 0:a.enabled)!=null?c:!1},"*")}function U(){window.parent!==window&&window.parent.postMessage({type:l.NETWORK_WARNING},"*")}const A={headphones:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,voiceIsolation:!1},speaker:{echoCancellation:!0,noiseSuppression:!1,autoGainControl:!0,voiceIsolation:!1}};function M(n){return A[n]||A.headphones}function v(n){return i(this,null,function*(){e.audioMode=n,E(n),V();const t=window.localStream;if(!t)return;const o=t.getAudioTracks()[0];if(o)try{yield o.applyConstraints(M(n))}catch(a){}})}function V(){window.parent!==window&&window.parent.postMessage({type:l.UPDATE_AUDIO_MODE,audioMode:e.audioMode},"*")}const F={speaker:"Prevents your mic from echoing film audio and voices back to the other person.",headphones:"Disables all mic processing for the best possible film audio quality."};function E(n){const t=e.elements.btnAudio;if(!t)return;const o=n==="speaker",a=t.querySelector(".audio-label"),c=t.querySelector(".audio-tooltip-desc");a&&(a.textContent=o?d.audioSpeaker:d.audioHeadphones),c&&(c.classList.add("audio-tooltip-fading"),setTimeout(()=>{c.textContent=F[n],c.classList.remove("audio-tooltip-fading")},300)),t.classList.toggle("audio-mode-speaker",o),t.classList.toggle("audio-mode-headphones",!o)}function j(){const n=e.elements.btnAudio;n&&(n.disabled=!1,E(e.audioMode),n.onclick=()=>{const t=e.audioMode==="headphones"?"speaker":"headphones";v(t)})}function C(n){const t=e.elements.btnMic;t&&(t.innerHTML=n?d.micOn:d.micOff)}function R(n){const t=e.elements.btnCam;t&&(t.innerHTML=n?d.camOn:d.camOff)}function D(n){const t=e.elements.localVideo;t&&(t.style.opacity=n?"1":"0.3")}function H(){const{btnMic:n,btnCam:t,btnAudio:o}=e.elements;n&&(n.disabled=!1),t&&(t.disabled=!1),o&&(o.disabled=!1)}function T(n){const t=e.elements.remoteVideo;if(!t||!n)return;const o=t.getBoundingClientRect();Object.assign(n.style,{position:"fixed",top:`${o.top}px`,left:`${o.left}px`,width:`${o.width}px`,height:`${o.height}px`,zIndex:"9999",background:"var(--call-overlay-bg)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"1.2rem",pointerEvents:"none",borderRadius:window.getComputedStyle(t).borderRadius})}function W(){const n=document.createElement("div");n.id="remoteLoading",n.innerHTML="<div>Calling...</div>",T(n),document.body.appendChild(n),e.elements.loadingOverlay=n,e.resizeListener=()=>{document.body.contains(n)&&T(n)},window.addEventListener("resize",e.resizeListener)}function h(n){const t=e.elements.loadingOverlay;t&&(t.innerHTML=n,T(t))}function $(){h(`
        <div style="text-align: center;">
            <div class="spinner call-spinner-circle"></div>
            <div>Waiting for video...</div>
        </div>
    `)}function I(){h(`
        <div style="text-align: center;">
            <div class="spinner call-spinner-circle"></div>
            <div>Reconnecting...</div>
        </div>
    `)}function G(){h("<div>Connection failed</div>"),S()}function X(){const n=e.elements.loadingOverlay;n&&(n.remove(),e.elements.loadingOverlay=null),S()}function S(){e.resizeListener&&(window.removeEventListener("resize",e.resizeListener),e.resizeListener=null)}function y(){e.connectionTimer&&(clearTimeout(e.connectionTimer),e.connectionTimer=null),e.disconnectedTimer&&(clearTimeout(e.disconnectedTimer),e.disconnectedTimer=null)}function k(){y(),e.connectionTimer=setTimeout(()=>{e.connectionEstablished||(console.error("[BingerCall] Connection timeout after",r.connectionTimeout,"ms"),f())},r.connectionTimeout)}function q(){e.disconnectedTimer||(e.disconnectedTimer=setTimeout(()=>{const n=e.peerConnection;n&&n.iceConnectionState==="disconnected"&&f(),e.disconnectedTimer=null},r.disconnectedTimeout))}function Z(){return i(this,null,function*(){return new Promise(n=>{const t=new RTCPeerConnection({iceServers:r.iceServers});let o=!1,a=!1;const c=p=>{a||(a=!0,t.close(),n(p))},z=setTimeout(()=>c(!0),r.networkProbeTimeout);t.onicecandidate=p=>{if(!p.candidate){clearTimeout(z),c(!o);return}const N=p.candidate.candidate;(N.includes("srflx")||N.includes("relay"))&&(o=!0)},t.createDataChannel("probe"),t.createOffer().then(p=>t.setLocalDescription(p)).catch(()=>{clearTimeout(z),c(!0)})})})}function K(){return i(this,null,function*(){try{const n=yield navigator.mediaDevices.getUserMedia({video:!0,audio:M(e.audioMode)});return window.localStream=n,e.localStream=n,n.getTracks().forEach(t=>{t.enabled=!1}),e.elements.localVideo.srcObject=n,H(),C(!1),R(!1),window.__pendingCamMicState&&(u(window.__pendingCamMicState.camOn,window.__pendingCamMicState.micOn),delete window.__pendingCamMicState),window.__pendingAudioMode&&(v(window.__pendingAudioMode),delete window.__pendingAudioMode),n}catch(n){return console.warn("[BingerCall] Camera/mic unavailable - receive-only mode:",n.message),null}})}function x(n=!1){const t={iceServers:r.iceServers,iceCandidatePoolSize:10};n&&(t.iceTransportPolicy="relay");const o=new RTCPeerConnection(t);return e.localStream?e.localStream.getTracks().forEach(a=>{o.addTrack(a,e.localStream)}):(o.addTransceiver("video",{direction:"recvonly"}),o.addTransceiver("audio",{direction:"recvonly"})),e.remoteStream=new MediaStream,e.elements.remoteVideo.srcObject=e.remoteStream,o.ontrack=a=>{e.remoteStream.addTrack(a.track)},o.onicecandidate=a=>{a.candidate&&e.signalsRef&&e.signalsRef.push({type:"candidate",from:e.userId,payload:a.candidate.toJSON()})},o.oniceconnectionstatechange=()=>Q(o),o.onicegatheringstatechange=()=>{},o.onconnectionstatechange=()=>{},e.peerConnection=o,o}function L(){e.peerConnection&&(e.peerConnection.oniceconnectionstatechange=null,e.peerConnection.ontrack=null,e.peerConnection.onicecandidate=null,e.peerConnection.onicegatheringstatechange=null,e.peerConnection.onconnectionstatechange=null,e.peerConnection.close(),e.peerConnection=null)}function Q(n){switch(n.iceConnectionState){case"checking":break;case"connected":case"completed":Y();break;case"disconnected":J();break;case"failed":ee();break}}function Y(){e.connectionEstablished&&!e.isReconnecting||(e.connectionEstablished=!0,e.isReconnecting=!1,e.iceRestartCount=0,y(),e.signalsRef&&e.signalsRef.remove().catch(()=>{}),$())}function J(){e.disconnectedTimer&&(clearTimeout(e.disconnectedTimer),e.disconnectedTimer=null),q()}function ee(){console.error("[BingerCall] ICE connection failed"),y(),f()}function f(){return i(this,null,function*(){if(e.iceRestartCount<r.maxIceRestarts){yield ne();return}if(!e.triedRelayOnly){yield te();return}yield _()})}function ne(){return i(this,null,function*(){e.iceRestartCount++,e.isReconnecting=!0,I();const n=e.peerConnection;if(!n){f();return}try{const t=yield n.createOffer({iceRestart:!0});yield n.setLocalDescription(t),e.signalsRef.push({type:"offer",from:e.userId,payload:t}),e.gotOffer=!1,k()}catch(t){console.warn("[BingerCall] ICE restart failed:",t.message),yield new Promise(o=>setTimeout(o,r.iceRestartDelay)),f()}})}function te(){return i(this,null,function*(){e.triedRelayOnly=!0,e.isReconnecting=!0,I(),L(),e.gotOffer=!1,e.connectionEstablished=!1,x(!0),k();try{yield B()}catch(n){console.warn("[BingerCall] Relay-only offer failed:",n.message),yield _()}})}function _(){return i(this,null,function*(){console.error("[BingerCall] All connection attempts exhausted"),e.isReconnecting=!1,G(),(yield Z())&&U()})}function oe(){return i(this,null,function*(){return new Promise(n=>{e.usersRef.once("value",t=>{const o=t.val()||{},a=Object.keys(o).sort();n(a[0]===e.userId)})})})}function ae(){e.signalListener&&e.signalsRef.off("child_added",e.signalListener),e.signalListener=n=>i(null,null,function*(){const t=n.val();if(!(!t||t.from===e.userId))try{yield ie(t)}catch(o){console.warn("[BingerCall] Signal error:",o.message)}}),e.signalsRef.on("child_added",e.signalListener)}function ie(n){return i(this,null,function*(){if(e.peerConnection)switch(n.type){case"offer":yield re(n.payload);break;case"answer":yield ce(n.payload);break;case"candidate":yield le(n.payload);break}})}function re(n){return i(this,null,function*(){const t=e.peerConnection;if(!(e.gotOffer&&!e.isReconnecting)){e.gotOffer=!0;try{yield t.setRemoteDescription(n);const o=yield t.createAnswer();yield t.setLocalDescription(o),e.signalsRef.push({type:"answer",from:e.userId,payload:o})}catch(o){throw console.error("[BingerCall] Failed to handle offer:",o.message),o}}})}function ce(n){return i(this,null,function*(){const t=e.peerConnection;if(!(t.currentRemoteDescription&&!e.isReconnecting))try{yield t.setRemoteDescription(n)}catch(o){throw console.error("[BingerCall] Failed to set remote description:",o.message),o}})}function le(n){return i(this,null,function*(){const t=e.peerConnection;if(t)try{yield t.addIceCandidate(new RTCIceCandidate(n))}catch(o){t.currentRemoteDescription&&console.warn("[BingerCall] ICE candidate error:",o.message)}})}function B(){return i(this,null,function*(){const n=e.peerConnection;if(!n)throw new Error("No peer connection");const t=yield n.createOffer();yield n.setLocalDescription(t),e.signalsRef.push({type:"offer",from:e.userId,payload:t})})}function se(){e.userRef=e.usersRef.child(e.userId),e.userRef.set({joined:Date.now()}),e.userRef.onDisconnect().remove()}function de(){const n=e.elements.btnMic;!n||!e.localStream||(n.onclick=()=>{const t=e.localStream.getAudioTracks()[0];t&&(t.enabled=!t.enabled,C(t.enabled),O())})}function ue(){const n=e.elements.btnCam;!n||!e.localStream||(n.onclick=()=>{const t=e.localStream.getVideoTracks()[0];t&&(t.enabled=!t.enabled,R(t.enabled),D(t.enabled),O())})}function P(){y(),e.signalListener&&e.signalsRef&&(e.signalsRef.off("child_added",e.signalListener),e.signalListener=null),L(),e.localStream&&(e.localStream.getTracks().forEach(n=>n.stop()),e.localStream=null,window.localStream=null),e.userRef&&(e.userRef.onDisconnect().cancel(),e.userRef.remove(),e.userRef=null),e.signalsRef&&e.signalsRef.remove().catch(()=>{}),e.usersRef&&e.usersRef.once("value",n=>{const t=n.val();(!t||Object.keys(t).length===0)&&e.roomRef&&e.roomRef.remove().catch(()=>{})}),S()}function fe(){e.elements.localVideo=document.getElementById("localVideo"),e.elements.remoteVideo=document.getElementById("remoteVideo"),e.elements.btnMic=document.getElementById("btnToggleMic"),e.elements.btnCam=document.getElementById("btnToggleCam"),e.elements.btnAudio=document.getElementById("btnToggleAudio")}function pe(n){return!n||!/^[a-zA-Z0-9_-]+$/.test(n)?null:n}function ge(n){return!n||!/^[a-zA-Z0-9_-]+$/.test(n)?null:n}function be(){const n=new URLSearchParams(window.location.search);return{roomId:pe(n.get("roomId")),uid:ge(n.get("uid"))}}function me(){return i(this,null,function*(){fe();try{yield firebase.app("caller").auth().signInAnonymously()}catch(o){console.error("[BingerCall] Firebase auth failed:",o.message)}const{roomId:n,uid:t}=be();if(!n||!t){h("<div>Invalid room or user</div>");return}e.roomId=n,e.userId=t,e.roomRef=g.ref(`calls/${e.roomId}`),e.usersRef=g.ref(`calls/${e.roomId}/users`),e.signalsRef=g.ref(`calls/${e.roomId}/signals`);try{yield e.signalsRef.remove()}catch(o){console.warn("[BingerCall] Failed to clear signals:",o.message)}if(se(),yield K(),de(),ue(),j(),x(!1),W(),ae(),e.isOfferer=yield oe(),k(),e.isOfferer)try{yield B()}catch(o){console.error("[BingerCall] Failed to send offer:",o.message),f()}e.elements.remoteVideo.onplaying=()=>{X()},window.addEventListener("beforeunload",P)})}document.addEventListener("DOMContentLoaded",me)})();
