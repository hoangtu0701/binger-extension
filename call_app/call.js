var a=(b,C,r)=>new Promise((d,l)=>{var e=s=>{try{f(r.next(s))}catch(p){l(p)}},m=s=>{try{f(r.throw(s))}catch(p){l(p)}},f=s=>s.done?d(s.value):Promise.resolve(s.value).then(e,m);f((r=r.apply(b,C)).next())});(function(){"use strict";const b="body{margin-top:4.6vh;font-family:system-ui,sans-serif;background:#111;color:#fff;display:flex;flex-direction:column;align-items:center;gap:6vh}.videos{display:flex;flex-direction:row;justify-content:center;gap:2vw;width:93vw;height:73vh}video{background:#000;width:50%;height:100%;max-width:480px;aspect-ratio:16/9;object-fit:cover;border:2px solid #444;border-radius:15px}.controls{display:flex;gap:8px}.controls button{background:#222;color:#ddd;transition:background .3s;padding:8px 12px;border-radius:8px;border:none;font-size:14px;cursor:pointer}.controls button:disabled{opacity:.5;cursor:not-allowed}.controls button:hover:not(:disabled){background:#333}.spinner{display:inline-block;animation:spin 1.2s linear infinite}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}",C=document.createElement("style");C.textContent=b,document.head.appendChild(C);const r={firebase:{apiKey:"AIzaSyDhppVbz4-sx1oYls62iXOPOR8Yrq-N9Qk",authDomain:"binger-video-call.firebaseapp.com",databaseURL:"https://binger-video-call-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"binger-video-call",storageBucket:"binger-video-call.firebasestorage.app",messagingSenderId:"1025922887951",appId:"1:1025922887951:web:70f733811d4ed19a8d8e7a"},connectionTimeout:3e4,disconnectedTimeout:1e4,networkProbeTimeout:5e3,maxIceRestarts:2,iceRestartDelay:1500,iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:["stun:hk-turn1.xirsys.com"]},{urls:"turn:free.expressturn.com:3478",username:"000000002068909891",credential:"aXZXgcUQf/fSE9PUID9byOo2BME="},{username:"X4wXbtbVmlOqNhOpTzEyIXrHCWjAeNepUjkzMoLOnDQyPPDnZeO3HCSKDDTIW6oEAAAAAGh_w2hob2FuZ3R1Mw==",credential:"35e524c2-671d-11f0-a840-0242ac120004",urls:["turn:hk-turn1.xirsys.com:80?transport=udp","turn:hk-turn1.xirsys.com:3478?transport=udp","turn:hk-turn1.xirsys.com:80?transport=tcp","turn:hk-turn1.xirsys.com:3478?transport=tcp","turns:hk-turn1.xirsys.com:443?transport=tcp","turns:hk-turn1.xirsys.com:5349?transport=tcp"]}]},d={micOn:"ðŸŽ¤ Mic",micOff:"ðŸš« Mic",camOn:"ðŸ“¹ Cam",camOff:"ðŸš« Cam"},l={RESTORE_CAM_MIC:"restoreCamMic",UPDATE_CAM_MIC:"updateCamMic",NETWORK_WARNING:"network-warning",CLEANUP_CALL:"cleanupCall",CLEANUP_DONE:"cleanupDone"},e={peerConnection:null,localStream:null,remoteStream:null,userId:null,roomId:null,isOfferer:!1,gotOffer:!1,connectionEstablished:!1,isReconnecting:!1,iceRestartCount:0,triedRelayOnly:!1,connectionTimer:null,disconnectedTimer:null,roomRef:null,usersRef:null,signalsRef:null,userRef:null,elements:{localVideo:null,remoteVideo:null,btnMic:null,btnCam:null,loadingOverlay:null},resizeListener:null,signalListener:null};window.localStream=null,firebase.initializeApp(r.firebase,"caller"),firebase.database.INTERNAL.forceWebSockets();const m=firebase.app("caller").database();window.addEventListener("message",n=>{const{type:t}=n.data||{};if(t===l.RESTORE_CAM_MIC){const{camOn:o,micOn:i}=n.data;if(!window.localStream){window.__pendingCamMicState={camOn:o,micOn:i};return}f(o,i);return}if(t===l.CLEANUP_CALL){x(),window.parent!==window&&window.parent.postMessage({type:l.CLEANUP_DONE},"*");return}});function f(n,t){const o=window.localStream;if(!o)return;const i=o.getVideoTracks()[0],c=o.getAudioTracks()[0];typeof n=="boolean"&&i&&(i.enabled=n,R(n),B(n)),typeof t=="boolean"&&c&&(c.enabled=t,h(t))}function s(){var t,o,i,c;if(window.parent===window)return;const n=window.localStream;n&&window.parent.postMessage({type:l.UPDATE_CAM_MIC,camOn:(o=(t=n.getVideoTracks()[0])==null?void 0:t.enabled)!=null?o:!1,micOn:(c=(i=n.getAudioTracks()[0])==null?void 0:i.enabled)!=null?c:!1},"*")}function p(){window.parent!==window&&window.parent.postMessage({type:l.NETWORK_WARNING},"*")}function h(n){const t=e.elements.btnMic;t&&(t.innerHTML=n?d.micOn:d.micOff)}function R(n){const t=e.elements.btnCam;t&&(t.innerHTML=n?d.camOn:d.camOff)}function B(n){const t=e.elements.localVideo;t&&(t.style.opacity=n?"1":"0.3")}function A(){const{btnMic:n,btnCam:t}=e.elements;n&&(n.disabled=!1),t&&(t.disabled=!1)}function v(n){const t=e.elements.remoteVideo;if(!t||!n)return;const o=t.getBoundingClientRect();Object.assign(n.style,{position:"fixed",top:`${o.top}px`,left:`${o.left}px`,width:`${o.width}px`,height:`${o.height}px`,zIndex:"9999",background:"rgba(0, 0, 0, 0.7)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"1.2rem",pointerEvents:"none",borderRadius:window.getComputedStyle(t).borderRadius})}function _(){const n=document.createElement("div");n.id="remoteLoading",n.innerHTML="<div>Calling...</div>",v(n),document.body.appendChild(n),e.elements.loadingOverlay=n,e.resizeListener=()=>{document.body.contains(n)&&v(n)},window.addEventListener("resize",e.resizeListener)}function w(n){const t=e.elements.loadingOverlay;t&&(t.innerHTML=n,v(t))}function P(){w(`
        <div style="text-align: center;">
            <div class="spinner" style="
                border: 4px solid #fff;
                border-top: 4px solid transparent;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                margin: 0 auto 12px;
            "></div>
            <div>Waiting for video...</div>
        </div>
    `)}function S(){w(`
        <div style="text-align: center;">
            <div class="spinner" style="
                border: 4px solid #fff;
                border-top: 4px solid transparent;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                margin: 0 auto 12px;
            "></div>
            <div>Reconnecting...</div>
        </div>
    `)}function N(){w("<div>Connection failed</div>"),T()}function z(){const n=e.elements.loadingOverlay;n&&(n.remove(),e.elements.loadingOverlay=null),T()}function T(){e.resizeListener&&(window.removeEventListener("resize",e.resizeListener),e.resizeListener=null)}function y(){e.connectionTimer&&(clearTimeout(e.connectionTimer),e.connectionTimer=null),e.disconnectedTimer&&(clearTimeout(e.disconnectedTimer),e.disconnectedTimer=null)}function I(){y(),e.connectionTimer=setTimeout(()=>{e.connectionEstablished||(console.error("[BingerCall] Connection timeout after",r.connectionTimeout,"ms"),u())},r.connectionTimeout)}function V(){e.disconnectedTimer||(e.disconnectedTimer=setTimeout(()=>{const n=e.peerConnection;n&&n.iceConnectionState==="disconnected"&&(console.error("[BingerCall] Disconnected timeout - attempting recovery"),u()),e.disconnectedTimer=null},r.disconnectedTimeout))}function U(){return a(this,null,function*(){return new Promise(n=>{const t=new RTCPeerConnection({iceServers:r.iceServers});let o=!1,i=!1;const c=g=>{i||(i=!0,t.close(),n(g))},M=setTimeout(()=>c(!0),r.networkProbeTimeout);t.onicecandidate=g=>{if(!g.candidate){clearTimeout(M),c(!o);return}const D=g.candidate.candidate;(D.includes("srflx")||D.includes("relay"))&&(o=!0)},t.createDataChannel("probe"),t.createOffer().then(g=>t.setLocalDescription(g)).catch(()=>{clearTimeout(M),c(!0)})})})}function F(){return a(this,null,function*(){try{const n=yield navigator.mediaDevices.getUserMedia({video:!0,audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,voiceIsolation:!1}});return window.localStream=n,e.localStream=n,n.getTracks().forEach(t=>{t.enabled=!1}),e.elements.localVideo.srcObject=n,A(),h(!1),R(!1),window.__pendingCamMicState&&(f(window.__pendingCamMicState.camOn,window.__pendingCamMicState.micOn),delete window.__pendingCamMicState),console.log("[BingerCall] Local media ready"),n}catch(n){return console.warn("[BingerCall] Camera/mic unavailable - receive-only mode:",n.message),null}})}function k(n=!1){const t={iceServers:r.iceServers,iceCandidatePoolSize:10};n&&(t.iceTransportPolicy="relay",console.log("[BingerCall] Using relay-only mode"));const o=new RTCPeerConnection(t);return e.localStream?e.localStream.getTracks().forEach(i=>{o.addTrack(i,e.localStream)}):(o.addTransceiver("video",{direction:"recvonly"}),o.addTransceiver("audio",{direction:"recvonly"})),e.remoteStream=new MediaStream,e.elements.remoteVideo.srcObject=e.remoteStream,o.ontrack=i=>{console.log("[BingerCall] Remote track received:",i.track.kind),e.remoteStream.addTrack(i.track)},o.onicecandidate=i=>{i.candidate&&e.signalsRef&&e.signalsRef.push({type:"candidate",from:e.userId,payload:i.candidate.toJSON()})},o.oniceconnectionstatechange=()=>j(o),o.onicegatheringstatechange=()=>{console.log("[BingerCall] ICE gathering:",o.iceGatheringState)},o.onconnectionstatechange=()=>{console.log("[BingerCall] Connection state:",o.connectionState)},e.peerConnection=o,o}function O(){e.peerConnection&&(e.peerConnection.oniceconnectionstatechange=null,e.peerConnection.ontrack=null,e.peerConnection.onicecandidate=null,e.peerConnection.onicegatheringstatechange=null,e.peerConnection.onconnectionstatechange=null,e.peerConnection.close(),e.peerConnection=null)}function j(n){const t=n.iceConnectionState;switch(console.log("[BingerCall] ICE state:",t),t){case"checking":break;case"connected":case"completed":W();break;case"disconnected":$();break;case"failed":G();break;case"closed":console.log("[BingerCall] Connection closed");break}}function W(){e.connectionEstablished&&!e.isReconnecting||(e.connectionEstablished=!0,e.isReconnecting=!1,e.iceRestartCount=0,y(),console.log("[BingerCall] Connection established"),e.signalsRef&&e.signalsRef.remove().catch(()=>{}),P())}function $(){console.warn("[BingerCall] Disconnected - waiting for recovery..."),e.disconnectedTimer&&(clearTimeout(e.disconnectedTimer),e.disconnectedTimer=null),V()}function G(){console.error("[BingerCall] ICE connection failed"),y(),u()}function u(){return a(this,null,function*(){if(e.iceRestartCount<r.maxIceRestarts){yield H();return}if(!e.triedRelayOnly){yield X();return}yield E()})}function H(){return a(this,null,function*(){e.iceRestartCount++,e.isReconnecting=!0,console.log("[BingerCall] ICE restart attempt",e.iceRestartCount,"of",r.maxIceRestarts),S();const n=e.peerConnection;if(!n){console.warn("[BingerCall] No peer connection for ICE restart"),u();return}try{const t=yield n.createOffer({iceRestart:!0});yield n.setLocalDescription(t),e.signalsRef.push({type:"offer",from:e.userId,payload:t}),e.gotOffer=!1,I(),console.log("[BingerCall] ICE restart offer sent")}catch(t){console.warn("[BingerCall] ICE restart failed:",t.message),yield new Promise(o=>setTimeout(o,r.iceRestartDelay)),u()}})}function X(){return a(this,null,function*(){e.triedRelayOnly=!0,e.isReconnecting=!0,console.log("[BingerCall] Attempting relay-only connection"),S(),O(),e.gotOffer=!1,e.connectionEstablished=!1,k(!0),I();try{yield L()}catch(n){console.warn("[BingerCall] Relay-only offer failed:",n.message),yield E()}})}function E(){return a(this,null,function*(){console.error("[BingerCall] All connection attempts exhausted"),e.isReconnecting=!1,N(),(yield U())&&(console.log("[BingerCall] Network appears restricted"),p())})}function Z(){return a(this,null,function*(){return new Promise(n=>{e.usersRef.once("value",t=>{const o=t.val()||{},i=Object.keys(o).sort(),c=i[0]===e.userId;console.log("[BingerCall] Users:",i.length,"| Role:",c?"offerer":"answerer"),n(c)})})})}function K(){e.signalListener&&e.signalsRef.off("child_added",e.signalListener),e.signalListener=n=>a(null,null,function*(){const t=n.val();if(!(!t||t.from===e.userId))try{yield Q(t)}catch(o){console.warn("[BingerCall] Signal error:",o.message)}}),e.signalsRef.on("child_added",e.signalListener)}function Q(n){return a(this,null,function*(){if(e.peerConnection)switch(n.type){case"offer":yield q(n.payload);break;case"answer":yield J(n.payload);break;case"candidate":yield Y(n.payload);break}})}function q(n){return a(this,null,function*(){const t=e.peerConnection;if(e.gotOffer&&!e.isReconnecting){console.log("[BingerCall] Ignoring duplicate offer");return}e.isReconnecting&&console.log("[BingerCall] Received offer during reconnection"),e.gotOffer=!0,console.log("[BingerCall] Received offer");try{yield t.setRemoteDescription(n);const o=yield t.createAnswer();yield t.setLocalDescription(o),e.signalsRef.push({type:"answer",from:e.userId,payload:o}),console.log("[BingerCall] Sent answer")}catch(o){throw console.error("[BingerCall] Failed to handle offer:",o.message),o}})}function J(n){return a(this,null,function*(){const t=e.peerConnection;if(t.currentRemoteDescription&&!e.isReconnecting){console.log("[BingerCall] Ignoring duplicate answer");return}console.log("[BingerCall] Received answer");try{yield t.setRemoteDescription(n)}catch(o){throw console.error("[BingerCall] Failed to set remote description:",o.message),o}})}function Y(n){return a(this,null,function*(){const t=e.peerConnection;if(t)try{yield t.addIceCandidate(new RTCIceCandidate(n))}catch(o){t.currentRemoteDescription&&console.warn("[BingerCall] ICE candidate error:",o.message)}})}function L(){return a(this,null,function*(){const n=e.peerConnection;if(!n)throw new Error("No peer connection");const t=yield n.createOffer();yield n.setLocalDescription(t),e.signalsRef.push({type:"offer",from:e.userId,payload:t}),console.log("[BingerCall] Sent offer")})}function ee(){e.userRef=e.usersRef.child(e.userId),e.userRef.set({joined:Date.now()}),e.userRef.onDisconnect().remove(),console.log("[BingerCall] Joined as:",e.userId)}function ne(){const n=e.elements.btnMic;!n||!e.localStream||(n.onclick=()=>{const t=e.localStream.getAudioTracks()[0];t&&(t.enabled=!t.enabled,h(t.enabled),s())})}function te(){const n=e.elements.btnCam;!n||!e.localStream||(n.onclick=()=>{const t=e.localStream.getVideoTracks()[0];t&&(t.enabled=!t.enabled,R(t.enabled),B(t.enabled),s())})}function x(){console.log("[BingerCall] Cleaning up"),y(),e.signalListener&&e.signalsRef&&(e.signalsRef.off("child_added",e.signalListener),e.signalListener=null),O(),e.localStream&&(e.localStream.getTracks().forEach(n=>n.stop()),e.localStream=null,window.localStream=null),e.userRef&&(e.userRef.onDisconnect().cancel(),e.userRef.remove(),e.userRef=null),e.signalsRef&&e.signalsRef.remove().catch(()=>{}),e.usersRef&&e.usersRef.once("value",n=>{const t=n.val();(!t||Object.keys(t).length===0)&&e.roomRef&&e.roomRef.remove().catch(()=>{})}),T()}function oe(){e.elements.localVideo=document.getElementById("localVideo"),e.elements.remoteVideo=document.getElementById("remoteVideo"),e.elements.btnMic=document.getElementById("btnToggleMic"),e.elements.btnCam=document.getElementById("btnToggleCam")}function ie(n){return n?/^[a-zA-Z0-9_-]+$/.test(n)?n:(console.error("[BingerCall] Invalid roomId format:",n),null):(console.error("[BingerCall] Missing roomId"),null)}function re(n){return n?/^[a-zA-Z0-9_-]+$/.test(n)?n:(console.error("[BingerCall] Invalid uid format:",n),null):(console.error("[BingerCall] Missing uid"),null)}function ae(){const n=new URLSearchParams(window.location.search);return{roomId:ie(n.get("roomId")),uid:re(n.get("uid"))}}function ce(){return a(this,null,function*(){console.log("[BingerCall] Initializing..."),oe();try{yield firebase.app("caller").auth().signInAnonymously(),console.log("[BingerCall] Firebase auth success")}catch(o){console.error("[BingerCall] Firebase auth failed:",o.message)}const{roomId:n,uid:t}=ae();if(!n||!t){w("<div>Invalid room or user</div>");return}e.roomId=n,e.userId=t,console.log("[BingerCall] Room:",e.roomId,"| User:",e.userId),e.roomRef=m.ref(`calls/${e.roomId}`),e.usersRef=m.ref(`calls/${e.roomId}/users`),e.signalsRef=m.ref(`calls/${e.roomId}/signals`);try{yield e.signalsRef.remove(),console.log("[BingerCall] Cleared stale signals")}catch(o){console.warn("[BingerCall] Failed to clear signals:",o.message)}if(ee(),yield F(),ne(),te(),k(!1),_(),K(),e.isOfferer=yield Z(),I(),e.isOfferer)try{yield L()}catch(o){console.error("[BingerCall] Failed to send offer:",o.message),u()}else console.log("[BingerCall] Waiting for offer...");e.elements.remoteVideo.onplaying=()=>{console.log("[BingerCall] Remote video playing"),z()},window.addEventListener("beforeunload",x),console.log("[BingerCall] Ready")})}document.addEventListener("DOMContentLoaded",ce)})();
