var r=(w,p,i)=>new Promise((d,s)=>{var e=c=>{try{b(i.next(c))}catch(u){s(u)}},g=c=>{try{b(i.throw(c))}catch(u){s(u)}},b=c=>c.done?d(c.value):Promise.resolve(c.value).then(e,g);b((i=i.apply(w,p)).next())});(function(){"use strict";const w="body{--call-bg: #111;--call-video-bg: #000;--call-video-border: #444;--call-btn-bg: #222;--call-btn-color: #ddd;--call-btn-hover: #333;--call-text: #fff;--call-overlay-bg: rgba(0, 0, 0, .7);--call-spinner-border: #fff;margin-top:4.6vh;font-family:system-ui,sans-serif;background:var(--call-bg);color:var(--call-text);display:flex;flex-direction:column;align-items:center;gap:6vh}body.theme-burgundy{--call-bg: rgba(15, 5, 10, .95);--call-video-bg: rgba(8, 2, 5, .9);--call-video-border: rgba(180, 80, 100, .3);--call-btn-bg: rgba(140, 40, 55, .3);--call-btn-color: #d4a574;--call-btn-hover: rgba(140, 40, 55, .5);--call-overlay-bg: rgba(15, 5, 10, .85);--call-spinner-border: #d4a574}body.theme-pink{--call-bg: rgba(35, 18, 25, .95);--call-video-bg: rgba(20, 10, 15, .9);--call-video-border: rgba(220, 140, 170, .25);--call-btn-bg: rgba(210, 110, 140, .2);--call-btn-color: #e8a0b5;--call-btn-hover: rgba(210, 110, 140, .35);--call-overlay-bg: rgba(35, 18, 25, .85);--call-spinner-border: #e8a0b5}body.theme-blackwhite{--call-bg: rgba(6, 6, 8, .95);--call-video-bg: rgba(2, 2, 3, .9);--call-video-border: rgba(255, 255, 255, .1);--call-btn-bg: rgba(255, 255, 255, .06);--call-btn-color: rgba(255, 255, 255, .7);--call-btn-hover: rgba(255, 255, 255, .12);--call-overlay-bg: rgba(6, 6, 8, .9);--call-spinner-border: rgba(255, 255, 255, .7)}body.theme-ocean{--call-bg: rgba(4, 14, 24, .95);--call-video-bg: rgba(2, 8, 16, .9);--call-video-border: rgba(0, 180, 220, .2);--call-btn-bg: rgba(0, 100, 160, .25);--call-btn-color: #b0e8f0;--call-btn-hover: rgba(0, 100, 160, .4);--call-overlay-bg: rgba(4, 14, 24, .85);--call-spinner-border: #b0e8f0}body.theme-volcano{--call-bg: rgba(12, 6, 4, .95);--call-video-bg: rgba(6, 3, 2, .9);--call-video-border: rgba(255, 100, 30, .2);--call-btn-bg: rgba(200, 60, 10, .2);--call-btn-color: #e8a060;--call-btn-hover: rgba(200, 60, 10, .35);--call-overlay-bg: rgba(12, 6, 4, .85);--call-spinner-border: #e8a060}body.theme-forest{--call-bg: rgba(6, 14, 4, .95);--call-video-bg: rgba(3, 8, 2, .9);--call-video-border: rgba(100, 200, 100, .2);--call-btn-bg: rgba(60, 120, 40, .2);--call-btn-color: #c0e8a0;--call-btn-hover: rgba(60, 120, 40, .35);--call-overlay-bg: rgba(6, 14, 4, .85);--call-spinner-border: #c0e8a0}.videos{display:flex;flex-direction:row;justify-content:center;gap:2vw;width:93vw;height:73vh}video{background:var(--call-video-bg);width:50%;height:100%;max-width:480px;aspect-ratio:16/9;object-fit:cover;border:2px solid var(--call-video-border);border-radius:15px}.controls{display:flex;gap:8px}.controls button{background:var(--call-btn-bg);color:var(--call-btn-color);transition:background .3s;padding:8px 12px;border-radius:8px;border:none;font-size:14px;cursor:pointer}.controls button:disabled{opacity:.5;cursor:not-allowed}.controls button:hover:not(:disabled){background:var(--call-btn-hover)}.spinner{display:inline-block;animation:spin 1.2s linear infinite}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.call-spinner-circle{border:4px solid var(--call-spinner-border);border-top:4px solid transparent;border-radius:50%;width:30px;height:30px;margin:0 auto 12px}",p=document.createElement("style");p.textContent=w,document.head.appendChild(p);const i={firebase:{apiKey:"AIzaSyDhppVbz4-sx1oYls62iXOPOR8Yrq-N9Qk",authDomain:"binger-video-call.firebaseapp.com",databaseURL:"https://binger-video-call-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"binger-video-call",storageBucket:"binger-video-call.firebasestorage.app",messagingSenderId:"1025922887951",appId:"1:1025922887951:web:70f733811d4ed19a8d8e7a"},connectionTimeout:3e4,disconnectedTimeout:1e4,networkProbeTimeout:5e3,maxIceRestarts:2,iceRestartDelay:1500,iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:["stun:hk-turn1.xirsys.com"]},{urls:"turn:free.expressturn.com:3478",username:"000000002068909891",credential:"aXZXgcUQf/fSE9PUID9byOo2BME="},{username:"X4wXbtbVmlOqNhOpTzEyIXrHCWjAeNepUjkzMoLOnDQyPPDnZeO3HCSKDDTIW6oEAAAAAGh_w2hob2FuZ3R1Mw==",credential:"35e524c2-671d-11f0-a840-0242ac120004",urls:["turn:hk-turn1.xirsys.com:80?transport=udp","turn:hk-turn1.xirsys.com:3478?transport=udp","turn:hk-turn1.xirsys.com:80?transport=tcp","turn:hk-turn1.xirsys.com:3478?transport=tcp","turns:hk-turn1.xirsys.com:443?transport=tcp","turns:hk-turn1.xirsys.com:5349?transport=tcp"]}]},d={micOn:"ðŸŽ¤ Mic",micOff:"ðŸš« Mic",camOn:"ðŸ“¹ Cam",camOff:"ðŸš« Cam"},s={RESTORE_CAM_MIC:"restoreCamMic",UPDATE_CAM_MIC:"updateCamMic",NETWORK_WARNING:"network-warning",CLEANUP_CALL:"cleanupCall",CLEANUP_DONE:"cleanupDone"},e={peerConnection:null,localStream:null,remoteStream:null,userId:null,roomId:null,isOfferer:!1,gotOffer:!1,connectionEstablished:!1,isReconnecting:!1,iceRestartCount:0,triedRelayOnly:!1,connectionTimer:null,disconnectedTimer:null,roomRef:null,usersRef:null,signalsRef:null,userRef:null,elements:{localVideo:null,remoteVideo:null,btnMic:null,btnCam:null,loadingOverlay:null},resizeListener:null,signalListener:null};window.localStream=null,firebase.initializeApp(i.firebase,"caller"),firebase.database.INTERNAL.forceWebSockets();const g=firebase.app("caller").database(),b=["theme-burgundy","theme-pink","theme-blackwhite","theme-ocean","theme-volcano","theme-forest"];function c(n){b.forEach(t=>document.body.classList.remove(t)),n&&n!=="default"&&document.body.classList.add(`theme-${n}`)}window.addEventListener("message",n=>{const{type:t}=n.data||{};if(t==="setTheme"){c(n.data.theme);return}if(t===s.RESTORE_CAM_MIC){const{camOn:a,micOn:o}=n.data;if(!window.localStream){window.__pendingCamMicState={camOn:a,micOn:o};return}u(a,o);return}if(t===s.CLEANUP_CALL){D(),window.parent!==window&&window.parent.postMessage({type:s.CLEANUP_DONE},"*");return}});function u(n,t){const a=window.localStream;if(!a)return;const o=a.getVideoTracks()[0],l=a.getAudioTracks()[0];typeof n=="boolean"&&o&&(o.enabled=n,C(n),O(n)),typeof t=="boolean"&&l&&(l.enabled=t,v(t))}function k(){var t,a,o,l;if(window.parent===window)return;const n=window.localStream;n&&window.parent.postMessage({type:s.UPDATE_CAM_MIC,camOn:(a=(t=n.getVideoTracks()[0])==null?void 0:t.enabled)!=null?a:!1,micOn:(l=(o=n.getAudioTracks()[0])==null?void 0:o.enabled)!=null?l:!1},"*")}function B(){window.parent!==window&&window.parent.postMessage({type:s.NETWORK_WARNING},"*")}function v(n){const t=e.elements.btnMic;t&&(t.innerHTML=n?d.micOn:d.micOff)}function C(n){const t=e.elements.btnCam;t&&(t.innerHTML=n?d.camOn:d.camOff)}function O(n){const t=e.elements.localVideo;t&&(t.style.opacity=n?"1":"0.3")}function P(){const{btnMic:n,btnCam:t}=e.elements;n&&(n.disabled=!1),t&&(t.disabled=!1)}function R(n){const t=e.elements.remoteVideo;if(!t||!n)return;const a=t.getBoundingClientRect();Object.assign(n.style,{position:"fixed",top:`${a.top}px`,left:`${a.left}px`,width:`${a.width}px`,height:`${a.height}px`,zIndex:"9999",background:"var(--call-overlay-bg)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"1.2rem",pointerEvents:"none",borderRadius:window.getComputedStyle(t).borderRadius})}function N(){const n=document.createElement("div");n.id="remoteLoading",n.innerHTML="<div>Calling...</div>",R(n),document.body.appendChild(n),e.elements.loadingOverlay=n,e.resizeListener=()=>{document.body.contains(n)&&R(n)},window.addEventListener("resize",e.resizeListener)}function y(n){const t=e.elements.loadingOverlay;t&&(t.innerHTML=n,R(t))}function z(){y(`
        <div style="text-align: center;">
            <div class="spinner call-spinner-circle"></div>
            <div>Waiting for video...</div>
        </div>
    `)}function E(){y(`
        <div style="text-align: center;">
            <div class="spinner call-spinner-circle"></div>
            <div>Reconnecting...</div>
        </div>
    `)}function V(){y("<div>Connection failed</div>"),T()}function F(){const n=e.elements.loadingOverlay;n&&(n.remove(),e.elements.loadingOverlay=null),T()}function T(){e.resizeListener&&(window.removeEventListener("resize",e.resizeListener),e.resizeListener=null)}function h(){e.connectionTimer&&(clearTimeout(e.connectionTimer),e.connectionTimer=null),e.disconnectedTimer&&(clearTimeout(e.disconnectedTimer),e.disconnectedTimer=null)}function S(){h(),e.connectionTimer=setTimeout(()=>{e.connectionEstablished||(console.error("[BingerCall] Connection timeout after",i.connectionTimeout,"ms"),f())},i.connectionTimeout)}function U(){e.disconnectedTimer||(e.disconnectedTimer=setTimeout(()=>{const n=e.peerConnection;n&&n.iceConnectionState==="disconnected"&&f(),e.disconnectedTimer=null},i.disconnectedTimeout))}function j(){return r(this,null,function*(){return new Promise(n=>{const t=new RTCPeerConnection({iceServers:i.iceServers});let a=!1,o=!1;const l=m=>{o||(o=!0,t.close(),n(m))},A=setTimeout(()=>l(!0),i.networkProbeTimeout);t.onicecandidate=m=>{if(!m.candidate){clearTimeout(A),l(!a);return}const _=m.candidate.candidate;(_.includes("srflx")||_.includes("relay"))&&(a=!0)},t.createDataChannel("probe"),t.createOffer().then(m=>t.setLocalDescription(m)).catch(()=>{clearTimeout(A),l(!0)})})})}function W(){return r(this,null,function*(){try{const n=yield navigator.mediaDevices.getUserMedia({video:!0,audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,voiceIsolation:!1}});return window.localStream=n,e.localStream=n,n.getTracks().forEach(t=>{t.enabled=!1}),e.elements.localVideo.srcObject=n,P(),v(!1),C(!1),window.__pendingCamMicState&&(u(window.__pendingCamMicState.camOn,window.__pendingCamMicState.micOn),delete window.__pendingCamMicState),n}catch(n){return console.warn("[BingerCall] Camera/mic unavailable - receive-only mode:",n.message),null}})}function L(n=!1){const t={iceServers:i.iceServers,iceCandidatePoolSize:10};n&&(t.iceTransportPolicy="relay");const a=new RTCPeerConnection(t);return e.localStream?e.localStream.getTracks().forEach(o=>{a.addTrack(o,e.localStream)}):(a.addTransceiver("video",{direction:"recvonly"}),a.addTransceiver("audio",{direction:"recvonly"})),e.remoteStream=new MediaStream,e.elements.remoteVideo.srcObject=e.remoteStream,a.ontrack=o=>{e.remoteStream.addTrack(o.track)},a.onicecandidate=o=>{o.candidate&&e.signalsRef&&e.signalsRef.push({type:"candidate",from:e.userId,payload:o.candidate.toJSON()})},a.oniceconnectionstatechange=()=>$(a),a.onicegatheringstatechange=()=>{},a.onconnectionstatechange=()=>{},e.peerConnection=a,a}function I(){e.peerConnection&&(e.peerConnection.oniceconnectionstatechange=null,e.peerConnection.ontrack=null,e.peerConnection.onicecandidate=null,e.peerConnection.onicegatheringstatechange=null,e.peerConnection.onconnectionstatechange=null,e.peerConnection.close(),e.peerConnection=null)}function $(n){switch(n.iceConnectionState){case"checking":break;case"connected":case"completed":H();break;case"disconnected":G();break;case"failed":X();break}}function H(){e.connectionEstablished&&!e.isReconnecting||(e.connectionEstablished=!0,e.isReconnecting=!1,e.iceRestartCount=0,h(),e.signalsRef&&e.signalsRef.remove().catch(()=>{}),z())}function G(){e.disconnectedTimer&&(clearTimeout(e.disconnectedTimer),e.disconnectedTimer=null),U()}function X(){console.error("[BingerCall] ICE connection failed"),h(),f()}function f(){return r(this,null,function*(){if(e.iceRestartCount<i.maxIceRestarts){yield Z();return}if(!e.triedRelayOnly){yield K();return}yield M()})}function Z(){return r(this,null,function*(){e.iceRestartCount++,e.isReconnecting=!0,E();const n=e.peerConnection;if(!n){f();return}try{const t=yield n.createOffer({iceRestart:!0});yield n.setLocalDescription(t),e.signalsRef.push({type:"offer",from:e.userId,payload:t}),e.gotOffer=!1,S()}catch(t){console.warn("[BingerCall] ICE restart failed:",t.message),yield new Promise(a=>setTimeout(a,i.iceRestartDelay)),f()}})}function K(){return r(this,null,function*(){e.triedRelayOnly=!0,e.isReconnecting=!0,E(),I(),e.gotOffer=!1,e.connectionEstablished=!1,L(!0),S();try{yield x()}catch(n){console.warn("[BingerCall] Relay-only offer failed:",n.message),yield M()}})}function M(){return r(this,null,function*(){console.error("[BingerCall] All connection attempts exhausted"),e.isReconnecting=!1,V(),(yield j())&&B()})}function Q(){return r(this,null,function*(){return new Promise(n=>{e.usersRef.once("value",t=>{const a=t.val()||{},o=Object.keys(a).sort();n(o[0]===e.userId)})})})}function q(){e.signalListener&&e.signalsRef.off("child_added",e.signalListener),e.signalListener=n=>r(null,null,function*(){const t=n.val();if(!(!t||t.from===e.userId))try{yield Y(t)}catch(a){console.warn("[BingerCall] Signal error:",a.message)}}),e.signalsRef.on("child_added",e.signalListener)}function Y(n){return r(this,null,function*(){if(e.peerConnection)switch(n.type){case"offer":yield J(n.payload);break;case"answer":yield ee(n.payload);break;case"candidate":yield ne(n.payload);break}})}function J(n){return r(this,null,function*(){const t=e.peerConnection;if(!(e.gotOffer&&!e.isReconnecting)){e.gotOffer=!0;try{yield t.setRemoteDescription(n);const a=yield t.createAnswer();yield t.setLocalDescription(a),e.signalsRef.push({type:"answer",from:e.userId,payload:a})}catch(a){throw console.error("[BingerCall] Failed to handle offer:",a.message),a}}})}function ee(n){return r(this,null,function*(){const t=e.peerConnection;if(!(t.currentRemoteDescription&&!e.isReconnecting))try{yield t.setRemoteDescription(n)}catch(a){throw console.error("[BingerCall] Failed to set remote description:",a.message),a}})}function ne(n){return r(this,null,function*(){const t=e.peerConnection;if(t)try{yield t.addIceCandidate(new RTCIceCandidate(n))}catch(a){t.currentRemoteDescription&&console.warn("[BingerCall] ICE candidate error:",a.message)}})}function x(){return r(this,null,function*(){const n=e.peerConnection;if(!n)throw new Error("No peer connection");const t=yield n.createOffer();yield n.setLocalDescription(t),e.signalsRef.push({type:"offer",from:e.userId,payload:t})})}function te(){e.userRef=e.usersRef.child(e.userId),e.userRef.set({joined:Date.now()}),e.userRef.onDisconnect().remove()}function ae(){const n=e.elements.btnMic;!n||!e.localStream||(n.onclick=()=>{const t=e.localStream.getAudioTracks()[0];t&&(t.enabled=!t.enabled,v(t.enabled),k())})}function oe(){const n=e.elements.btnCam;!n||!e.localStream||(n.onclick=()=>{const t=e.localStream.getVideoTracks()[0];t&&(t.enabled=!t.enabled,C(t.enabled),O(t.enabled),k())})}function D(){h(),e.signalListener&&e.signalsRef&&(e.signalsRef.off("child_added",e.signalListener),e.signalListener=null),I(),e.localStream&&(e.localStream.getTracks().forEach(n=>n.stop()),e.localStream=null,window.localStream=null),e.userRef&&(e.userRef.onDisconnect().cancel(),e.userRef.remove(),e.userRef=null),e.signalsRef&&e.signalsRef.remove().catch(()=>{}),e.usersRef&&e.usersRef.once("value",n=>{const t=n.val();(!t||Object.keys(t).length===0)&&e.roomRef&&e.roomRef.remove().catch(()=>{})}),T()}function re(){e.elements.localVideo=document.getElementById("localVideo"),e.elements.remoteVideo=document.getElementById("remoteVideo"),e.elements.btnMic=document.getElementById("btnToggleMic"),e.elements.btnCam=document.getElementById("btnToggleCam")}function ie(n){return!n||!/^[a-zA-Z0-9_-]+$/.test(n)?null:n}function ce(n){return!n||!/^[a-zA-Z0-9_-]+$/.test(n)?null:n}function le(){const n=new URLSearchParams(window.location.search);return{roomId:ie(n.get("roomId")),uid:ce(n.get("uid"))}}function se(){return r(this,null,function*(){re();try{yield firebase.app("caller").auth().signInAnonymously()}catch(a){console.error("[BingerCall] Firebase auth failed:",a.message)}const{roomId:n,uid:t}=le();if(!n||!t){y("<div>Invalid room or user</div>");return}e.roomId=n,e.userId=t,e.roomRef=g.ref(`calls/${e.roomId}`),e.usersRef=g.ref(`calls/${e.roomId}/users`),e.signalsRef=g.ref(`calls/${e.roomId}/signals`);try{yield e.signalsRef.remove()}catch(a){console.warn("[BingerCall] Failed to clear signals:",a.message)}if(te(),yield W(),ae(),oe(),L(!1),N(),q(),e.isOfferer=yield Q(),S(),e.isOfferer)try{yield x()}catch(a){console.error("[BingerCall] Failed to send offer:",a.message),f()}e.elements.remoteVideo.onplaying=()=>{F()},window.addEventListener("beforeunload",D)})}document.addEventListener("DOMContentLoaded",se)})();
