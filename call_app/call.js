var a=(b,w,r)=>new Promise((d,l)=>{var e=c=>{try{u(r.next(c))}catch(g){l(g)}},p=c=>{try{u(r.throw(c))}catch(g){l(g)}},u=c=>c.done?d(c.value):Promise.resolve(c.value).then(e,p);u((r=r.apply(b,w)).next())});(function(){"use strict";const b="body{margin-top:4.6vh;font-family:system-ui,sans-serif;background:#111;color:#fff;display:flex;flex-direction:column;align-items:center;gap:6vh}.videos{display:flex;flex-direction:row;justify-content:center;gap:2vw;width:93vw;height:73vh}video{background:#000;width:50%;height:100%;max-width:480px;aspect-ratio:16/9;object-fit:cover;border:2px solid #444;border-radius:15px}.controls{display:flex;gap:8px}.controls button{background:#222;color:#ddd;transition:background .3s;padding:8px 12px;border-radius:8px;border:none;font-size:14px;cursor:pointer}.controls button:disabled{opacity:.5;cursor:not-allowed}.controls button:hover:not(:disabled){background:#333}.spinner{display:inline-block;animation:spin 1.2s linear infinite}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}",w=document.createElement("style");w.textContent=b,document.head.appendChild(w);const r={firebase:{apiKey:"AIzaSyDhppVbz4-sx1oYls62iXOPOR8Yrq-N9Qk",authDomain:"binger-video-call.firebaseapp.com",databaseURL:"https://binger-video-call-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"binger-video-call",storageBucket:"binger-video-call.firebasestorage.app",messagingSenderId:"1025922887951",appId:"1:1025922887951:web:70f733811d4ed19a8d8e7a"},connectionTimeout:3e4,disconnectedTimeout:1e4,networkProbeTimeout:5e3,maxIceRestarts:2,iceRestartDelay:1500,iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:["stun:hk-turn1.xirsys.com"]},{urls:"turn:free.expressturn.com:3478",username:"000000002068909891",credential:"aXZXgcUQf/fSE9PUID9byOo2BME="},{username:"X4wXbtbVmlOqNhOpTzEyIXrHCWjAeNepUjkzMoLOnDQyPPDnZeO3HCSKDDTIW6oEAAAAAGh_w2hob2FuZ3R1Mw==",credential:"35e524c2-671d-11f0-a840-0242ac120004",urls:["turn:hk-turn1.xirsys.com:80?transport=udp","turn:hk-turn1.xirsys.com:3478?transport=udp","turn:hk-turn1.xirsys.com:80?transport=tcp","turn:hk-turn1.xirsys.com:3478?transport=tcp","turns:hk-turn1.xirsys.com:443?transport=tcp","turns:hk-turn1.xirsys.com:5349?transport=tcp"]}]},d={micOn:"ðŸŽ¤ Mic",micOff:"ðŸš« Mic",camOn:"ðŸ“¹ Cam",camOff:"ðŸš« Cam"},l={RESTORE_CAM_MIC:"restoreCamMic",UPDATE_CAM_MIC:"updateCamMic",NETWORK_WARNING:"network-warning",CLEANUP_CALL:"cleanupCall",CLEANUP_DONE:"cleanupDone"},e={peerConnection:null,localStream:null,remoteStream:null,userId:null,roomId:null,isOfferer:!1,gotOffer:!1,connectionEstablished:!1,isReconnecting:!1,iceRestartCount:0,triedRelayOnly:!1,connectionTimer:null,disconnectedTimer:null,roomRef:null,usersRef:null,signalsRef:null,userRef:null,elements:{localVideo:null,remoteVideo:null,btnMic:null,btnCam:null,loadingOverlay:null},resizeListener:null,signalListener:null};window.localStream=null,firebase.initializeApp(r.firebase,"caller"),firebase.database.INTERNAL.forceWebSockets();const p=firebase.app("caller").database();window.addEventListener("message",n=>{const{type:t}=n.data||{};if(t===l.RESTORE_CAM_MIC){const{camOn:i,micOn:o}=n.data;if(!window.localStream){window.__pendingCamMicState={camOn:i,micOn:o};return}u(i,o);return}if(t===l.CLEANUP_CALL){M(),window.parent!==window&&window.parent.postMessage({type:l.CLEANUP_DONE},"*");return}});function u(n,t){const i=window.localStream;if(!i)return;const o=i.getVideoTracks()[0],s=i.getAudioTracks()[0];typeof n=="boolean"&&o&&(o.enabled=n,v(n),O(n)),typeof t=="boolean"&&s&&(s.enabled=t,h(t))}function c(){var t,i,o,s;if(window.parent===window)return;const n=window.localStream;n&&window.parent.postMessage({type:l.UPDATE_CAM_MIC,camOn:(i=(t=n.getVideoTracks()[0])==null?void 0:t.enabled)!=null?i:!1,micOn:(s=(o=n.getAudioTracks()[0])==null?void 0:o.enabled)!=null?s:!1},"*")}function g(){window.parent!==window&&window.parent.postMessage({type:l.NETWORK_WARNING},"*")}function h(n){const t=e.elements.btnMic;t&&(t.innerHTML=n?d.micOn:d.micOff)}function v(n){const t=e.elements.btnCam;t&&(t.innerHTML=n?d.camOn:d.camOff)}function O(n){const t=e.elements.localVideo;t&&(t.style.opacity=n?"1":"0.3")}function _(){const{btnMic:n,btnCam:t}=e.elements;n&&(n.disabled=!1),t&&(t.disabled=!1)}function R(n){const t=e.elements.remoteVideo;if(!t||!n)return;const i=t.getBoundingClientRect();Object.assign(n.style,{position:"fixed",top:`${i.top}px`,left:`${i.left}px`,width:`${i.width}px`,height:`${i.height}px`,zIndex:"9999",background:"rgba(0, 0, 0, 0.7)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"1.2rem",pointerEvents:"none",borderRadius:window.getComputedStyle(t).borderRadius})}function B(){const n=document.createElement("div");n.id="remoteLoading",n.innerHTML="<div>Calling...</div>",R(n),document.body.appendChild(n),e.elements.loadingOverlay=n,e.resizeListener=()=>{document.body.contains(n)&&R(n)},window.addEventListener("resize",e.resizeListener)}function y(n){const t=e.elements.loadingOverlay;t&&(t.innerHTML=n,R(t))}function P(){y(`
        <div style="text-align: center;">
            <div class="spinner" style="
                border: 4px solid #fff;
                border-top: 4px solid transparent;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                margin: 0 auto 12px;
            "></div>
            <div>Waiting for video...</div>
        </div>
    `)}function k(){y(`
        <div style="text-align: center;">
            <div class="spinner" style="
                border: 4px solid #fff;
                border-top: 4px solid transparent;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                margin: 0 auto 12px;
            "></div>
            <div>Reconnecting...</div>
        </div>
    `)}function N(){y("<div>Connection failed</div>"),T()}function z(){const n=e.elements.loadingOverlay;n&&(n.remove(),e.elements.loadingOverlay=null),T()}function T(){e.resizeListener&&(window.removeEventListener("resize",e.resizeListener),e.resizeListener=null)}function C(){e.connectionTimer&&(clearTimeout(e.connectionTimer),e.connectionTimer=null),e.disconnectedTimer&&(clearTimeout(e.disconnectedTimer),e.disconnectedTimer=null)}function S(){C(),e.connectionTimer=setTimeout(()=>{e.connectionEstablished||(console.error("[BingerCall] Connection timeout after",r.connectionTimeout,"ms"),f())},r.connectionTimeout)}function V(){e.disconnectedTimer||(e.disconnectedTimer=setTimeout(()=>{const n=e.peerConnection;n&&n.iceConnectionState==="disconnected"&&f(),e.disconnectedTimer=null},r.disconnectedTimeout))}function F(){return a(this,null,function*(){return new Promise(n=>{const t=new RTCPeerConnection({iceServers:r.iceServers});let i=!1,o=!1;const s=m=>{o||(o=!0,t.close(),n(m))},D=setTimeout(()=>s(!0),r.networkProbeTimeout);t.onicecandidate=m=>{if(!m.candidate){clearTimeout(D),s(!i);return}const A=m.candidate.candidate;(A.includes("srflx")||A.includes("relay"))&&(i=!0)},t.createDataChannel("probe"),t.createOffer().then(m=>t.setLocalDescription(m)).catch(()=>{clearTimeout(D),s(!0)})})})}function U(){return a(this,null,function*(){try{const n=yield navigator.mediaDevices.getUserMedia({video:!0,audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,voiceIsolation:!1}});return window.localStream=n,e.localStream=n,n.getTracks().forEach(t=>{t.enabled=!1}),e.elements.localVideo.srcObject=n,_(),h(!1),v(!1),window.__pendingCamMicState&&(u(window.__pendingCamMicState.camOn,window.__pendingCamMicState.micOn),delete window.__pendingCamMicState),n}catch(n){return console.warn("[BingerCall] Camera/mic unavailable - receive-only mode:",n.message),null}})}function I(n=!1){const t={iceServers:r.iceServers,iceCandidatePoolSize:10};n&&(t.iceTransportPolicy="relay");const i=new RTCPeerConnection(t);return e.localStream?e.localStream.getTracks().forEach(o=>{i.addTrack(o,e.localStream)}):(i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"})),e.remoteStream=new MediaStream,e.elements.remoteVideo.srcObject=e.remoteStream,i.ontrack=o=>{e.remoteStream.addTrack(o.track)},i.onicecandidate=o=>{o.candidate&&e.signalsRef&&e.signalsRef.push({type:"candidate",from:e.userId,payload:o.candidate.toJSON()})},i.oniceconnectionstatechange=()=>j(i),i.onicegatheringstatechange=()=>{},i.onconnectionstatechange=()=>{},e.peerConnection=i,i}function L(){e.peerConnection&&(e.peerConnection.oniceconnectionstatechange=null,e.peerConnection.ontrack=null,e.peerConnection.onicecandidate=null,e.peerConnection.onicegatheringstatechange=null,e.peerConnection.onconnectionstatechange=null,e.peerConnection.close(),e.peerConnection=null)}function j(n){switch(n.iceConnectionState){case"checking":break;case"connected":case"completed":W();break;case"disconnected":$();break;case"failed":G();break}}function W(){e.connectionEstablished&&!e.isReconnecting||(e.connectionEstablished=!0,e.isReconnecting=!1,e.iceRestartCount=0,C(),e.signalsRef&&e.signalsRef.remove().catch(()=>{}),P())}function $(){e.disconnectedTimer&&(clearTimeout(e.disconnectedTimer),e.disconnectedTimer=null),V()}function G(){console.error("[BingerCall] ICE connection failed"),C(),f()}function f(){return a(this,null,function*(){if(e.iceRestartCount<r.maxIceRestarts){yield H();return}if(!e.triedRelayOnly){yield X();return}yield E()})}function H(){return a(this,null,function*(){e.iceRestartCount++,e.isReconnecting=!0,k();const n=e.peerConnection;if(!n){f();return}try{const t=yield n.createOffer({iceRestart:!0});yield n.setLocalDescription(t),e.signalsRef.push({type:"offer",from:e.userId,payload:t}),e.gotOffer=!1,S()}catch(t){console.warn("[BingerCall] ICE restart failed:",t.message),yield new Promise(i=>setTimeout(i,r.iceRestartDelay)),f()}})}function X(){return a(this,null,function*(){e.triedRelayOnly=!0,e.isReconnecting=!0,k(),L(),e.gotOffer=!1,e.connectionEstablished=!1,I(!0),S();try{yield x()}catch(n){console.warn("[BingerCall] Relay-only offer failed:",n.message),yield E()}})}function E(){return a(this,null,function*(){console.error("[BingerCall] All connection attempts exhausted"),e.isReconnecting=!1,N(),(yield F())&&g()})}function Z(){return a(this,null,function*(){return new Promise(n=>{e.usersRef.once("value",t=>{const i=t.val()||{},o=Object.keys(i).sort();n(o[0]===e.userId)})})})}function K(){e.signalListener&&e.signalsRef.off("child_added",e.signalListener),e.signalListener=n=>a(null,null,function*(){const t=n.val();if(!(!t||t.from===e.userId))try{yield Q(t)}catch(i){console.warn("[BingerCall] Signal error:",i.message)}}),e.signalsRef.on("child_added",e.signalListener)}function Q(n){return a(this,null,function*(){if(e.peerConnection)switch(n.type){case"offer":yield q(n.payload);break;case"answer":yield Y(n.payload);break;case"candidate":yield J(n.payload);break}})}function q(n){return a(this,null,function*(){const t=e.peerConnection;if(!(e.gotOffer&&!e.isReconnecting)){e.gotOffer=!0;try{yield t.setRemoteDescription(n);const i=yield t.createAnswer();yield t.setLocalDescription(i),e.signalsRef.push({type:"answer",from:e.userId,payload:i})}catch(i){throw console.error("[BingerCall] Failed to handle offer:",i.message),i}}})}function Y(n){return a(this,null,function*(){const t=e.peerConnection;if(!(t.currentRemoteDescription&&!e.isReconnecting))try{yield t.setRemoteDescription(n)}catch(i){throw console.error("[BingerCall] Failed to set remote description:",i.message),i}})}function J(n){return a(this,null,function*(){const t=e.peerConnection;if(t)try{yield t.addIceCandidate(new RTCIceCandidate(n))}catch(i){t.currentRemoteDescription&&console.warn("[BingerCall] ICE candidate error:",i.message)}})}function x(){return a(this,null,function*(){const n=e.peerConnection;if(!n)throw new Error("No peer connection");const t=yield n.createOffer();yield n.setLocalDescription(t),e.signalsRef.push({type:"offer",from:e.userId,payload:t})})}function ee(){e.userRef=e.usersRef.child(e.userId),e.userRef.set({joined:Date.now()}),e.userRef.onDisconnect().remove()}function ne(){const n=e.elements.btnMic;!n||!e.localStream||(n.onclick=()=>{const t=e.localStream.getAudioTracks()[0];t&&(t.enabled=!t.enabled,h(t.enabled),c())})}function te(){const n=e.elements.btnCam;!n||!e.localStream||(n.onclick=()=>{const t=e.localStream.getVideoTracks()[0];t&&(t.enabled=!t.enabled,v(t.enabled),O(t.enabled),c())})}function M(){C(),e.signalListener&&e.signalsRef&&(e.signalsRef.off("child_added",e.signalListener),e.signalListener=null),L(),e.localStream&&(e.localStream.getTracks().forEach(n=>n.stop()),e.localStream=null,window.localStream=null),e.userRef&&(e.userRef.onDisconnect().cancel(),e.userRef.remove(),e.userRef=null),e.signalsRef&&e.signalsRef.remove().catch(()=>{}),e.usersRef&&e.usersRef.once("value",n=>{const t=n.val();(!t||Object.keys(t).length===0)&&e.roomRef&&e.roomRef.remove().catch(()=>{})}),T()}function ie(){e.elements.localVideo=document.getElementById("localVideo"),e.elements.remoteVideo=document.getElementById("remoteVideo"),e.elements.btnMic=document.getElementById("btnToggleMic"),e.elements.btnCam=document.getElementById("btnToggleCam")}function oe(n){return!n||!/^[a-zA-Z0-9_-]+$/.test(n)?null:n}function ae(n){return!n||!/^[a-zA-Z0-9_-]+$/.test(n)?null:n}function re(){const n=new URLSearchParams(window.location.search);return{roomId:oe(n.get("roomId")),uid:ae(n.get("uid"))}}function ce(){return a(this,null,function*(){ie();try{yield firebase.app("caller").auth().signInAnonymously()}catch(i){console.error("[BingerCall] Firebase auth failed:",i.message)}const{roomId:n,uid:t}=re();if(!n||!t){y("<div>Invalid room or user</div>");return}e.roomId=n,e.userId=t,e.roomRef=p.ref(`calls/${e.roomId}`),e.usersRef=p.ref(`calls/${e.roomId}/users`),e.signalsRef=p.ref(`calls/${e.roomId}/signals`);try{yield e.signalsRef.remove()}catch(i){console.warn("[BingerCall] Failed to clear signals:",i.message)}if(ee(),yield U(),ne(),te(),I(!1),B(),K(),e.isOfferer=yield Z(),S(),e.isOfferer)try{yield x()}catch(i){console.error("[BingerCall] Failed to send offer:",i.message),f()}e.elements.remoteVideo.onplaying=()=>{z()},window.addEventListener("beforeunload",M)})}document.addEventListener("DOMContentLoaded",ce)})();
